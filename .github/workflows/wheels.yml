name: Build Python wheels

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: "liboqs release version"
        required: true

      publish-to-pypi:
        description: "Publish to PyPI after build?"
        type: boolean
        required: false
        default: false

      publish-to-testpypi:
        description: "Publish to TestPyPI after build?"
        type: boolean
        required: false
        default: false

permissions:
  contents: read

jobs:
  build-wheels:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch_value: x86_64

          - os: macos-latest
            platform: macos
            arch_value: universal2

          - os: windows-latest
            platform: windows
            arch_value: AMD64

    runs-on: ${{ matrix.os }}

    env:
      CIBW_PLATFORM: ${{ matrix.platform }}
      CIBW_ARCHS_LINUX: ${{ matrix.arch_value }}
      CIBW_ARCHS_MACOS: ${{ matrix.arch_value }}
      CIBW_ARCHS_WINDOWS: ${{ matrix.arch_value }}
      CIBW_SKIP: "pp*"
      LIBOQS_RELEASE_VERSION: ${{ github.event.inputs.release-version }}


    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache cibuildwheel
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-cibw-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-cibw-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel

      - name: Install MSYS2 on Windows
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@61f9e5e925871ba6c9e3e8da24ede83ea27fa91f
        with:
          msystem: MINGW64
          install: >-
            git
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-toolchain

      - name: Build liboqs from source (Linux/macOS)
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: |
          git clone --depth 1 --branch "$LIBOQS_RELEASE_VERSION" https://github.com/open-quantum-safe/liboqs.git
          cmake -S liboqs -B liboqs/build \
            -DCMAKE_INSTALL_PREFIX=oqs-install \
            -G Ninja \
            -DOQS_BUILD_ONLY_LIB=ON \
            -DOQS_MINIMAL_BUILD="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" \
            -DOQS_ALGS_ENABLED="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" \
            -DOQS_DIST_BUILD=OFF \
            -DOQS_USE_OPENSSL=OFF

          cmake --build liboqs/build --config Release --parallel
          cmake --install liboqs/build --config Release

      - name: Build liboqs from source (Windows MSVC)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          git clone --depth 1 --branch "%LIBOQS_RELEASE_VERSION%" https://github.com/open-quantum-safe/liboqs.git
          cmake -S liboqs -B liboqs/build ^
            -DCMAKE_INSTALL_PREFIX=oqs-install ^
            -DOQS_BUILD_ONLY_LIB=ON ^
            -DOQS_MINIMAL_BUILD="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" ^
            -DOQS_ALGS_ENABLED="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" ^
            -DOQS_DIST_BUILD=OFF ^
            -DOQS_USE_OPENSSL=OFF
          
          cmake --build liboqs/build --config Release --parallel
          cmake --install liboqs/build --config Release

      - name: Build wheels with cibuildwheel
        run: cibuildwheel --output-dir dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform }}-${{ matrix.arch_value }}
          path: dist/*.whl

      - name: Publish to PyPI (optional)
        if: github.event.inputs.publish-to-pypi == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload --non-interactive dist/*

      - name: Publish to TestPyPI (optional)
        if: github.event.inputs.publish-to-testpypi == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload --repository testpypi --verbose dist/*
