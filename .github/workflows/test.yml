name: Testing under sanitizers

on:
  workflow_dispatch:

jobs:
  testing:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential

      - name: Build and install liboqs
        run: |
          git clone --depth 1 --branch main https://github.com/open-quantum-safe/liboqs.git
          mkdir liboqs/build && cd liboqs/build
      
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../../oqs-install \    # <-- ADD THIS LINE
            -DCMAKE_C_FLAGS="-g -O1 -fno-omit-frame-pointer -fsanitize=address,undefined,leak" \
            -DCMAKE_CXX_FLAGS="-g -O1 -fno-omit-frame-pointer -fsanitize=address,undefined,leak" \
            -DOQS_MINIMAL_BUILD="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" \
            -DOQS_ALGS_ENABLED="KEM_ml_kem_512;KEM_ml_kem_768;KEM_ml_kem_1024;SIG_ml_dsa_44;SIG_ml_dsa_65;SIG_ml_dsa_87" \
            -DOQS_USE_OPENSSL=OFF
          ninja
          ninja install

      - name: Install Python package with dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Run tests under sanitizers
        run: pytest tests/
